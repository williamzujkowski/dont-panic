# Search Functionality

This document explains how the search functionality works in the dont-panic frontend.

## Overview

The dont-panic frontend provides client-side search capabilities for vulnerability reports using [Pagefind](https://pagefind.app/) via the [astro-pagefind](https://github.com/shishkin/astro-pagefind) integration. This enables fast, client-side searching without requiring a server component.

## How It Works

1. **Indexing**: During the build process, Pagefind scans the static HTML files generated by Astro and creates a search index.
2. **UI Component**: The `Search.astro` component provides a search input field and handles displaying search results.
3. **Client-Side Search**: When a user enters a search query, the Pagefind JavaScript library searches the pre-built index and returns relevant results.
4. **Dedicated Search Page**: A full-page search experience is available at `/search` for users who want a dedicated search interface.

## Implementation Details

### Integration Configuration

The Pagefind integration is configured in `astro.config.mjs`:

```javascript
import pagefind from 'astro-pagefind';

// In the defineConfig object:
integrations: [
  pagefind({
    searchPagePath: '/search',
    indexDist: true,
    customSelectors: [
      { selector: "h1", defaultType: "header" },
      { selector: "h2", defaultType: "header" },
      { selector: "h3", defaultType: "header" },
      { selector: "article", defaultType: "content" }
    ],
    excludeSelectors: [
      "nav", 
      "footer",
      "[data-pagefind-ignore]"
    ]
  })
]
```

This configuration:
- Sets up a dedicated search page at `/search`
- Creates a search index in the `dist` folder
- Adds custom selectors to include specific elements in the search
- Excludes navigation, footer, and elements with the `data-pagefind-ignore` attribute

### Search Component

The `Search.astro` component:

1. Renders a search input field
2. Applies styling to match the site design
3. Initializes the Pagefind UI with custom configuration

```astro
<div id="search" class="pagefind-ui" aria-label="Search vulnerability reports"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  if (typeof window.PagefindUI === 'function') {
    new window.PagefindUI({
      element: "#search",
      showImages: false,
      highlightParam: "highlight",
      placeholderText: "Search vulnerability reports...",
      resetStyles: false,
      showSubResults: true
    });
  }
});
</script>
```

### Dedicated Search Page

A full-page search experience is available at `/search`, which provides:

- A larger search interface
- Search tips and guidance
- Fallback options for when users can't find what they're looking for

## Search Configuration Options

The Pagefind UI can be customized with various options:

- `showImages`: Whether to display images in search results (default: false)
- `highlightParam`: URL parameter used for highlighting terms when navigating to a result
- `placeholderText`: Text displayed in the search input when empty
- `resetStyles`: Whether to reset default styles (set to false to use our custom styling)
- `showSubResults`: Whether to show additional matches within the same page

## Customizing Search Results

The search results display is styled using CSS variables defined in `:root` and specific CSS classes for different elements of the search UI. These styles can be customized in the `Search.astro` component.

## Controlling What Gets Indexed

You can control what content is included in the search index:

1. **Include specific content** using `customSelectors` in the Pagefind configuration
2. **Exclude content** using `excludeSelectors` or by adding the `data-pagefind-ignore` attribute to HTML elements
3. **Boost certain content** using the `data-pagefind-weight` attribute
4. **Add custom metadata** using `data-pagefind-meta` attributes

Example:

```html
<!-- Exclude from search -->
<div data-pagefind-ignore>This won't be searchable</div>

<!-- Boost importance in search results -->
<h1 data-pagefind-weight="10">High priority content</h1>

<!-- Add custom metadata -->
<div data-pagefind-meta="category:critical">Important vulnerability</div>
```

## Troubleshooting

If search isn't working correctly:

1. **Check the console for errors** - Look for any JavaScript errors related to Pagefind
2. **Verify the Pagefind files exist** - After building, check that `/dist/pagefind/` directory contains the search index files
3. **Test with a full build** - Run `npm run build && npm run preview` to test with a complete production build
4. **Check integration configuration** - Ensure the astro-pagefind integration is properly configured in `astro.config.mjs`
5. **Try the dedicated search page** - Navigate to `/search` to see if the search works on the dedicated page

## Performance Considerations

Pagefind is designed to be lightweight and performant:

- The search index is loaded only when needed
- The UI bundle is small (~6KB gzipped)
- Search is performed entirely client-side
- The index is split into chunks for faster loading

For very large sites with thousands of pages, consider adjusting the Pagefind configuration options for optimal performance.