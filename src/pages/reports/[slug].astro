---
// src/pages/reports/[slug].astro
---
// src/pages/reports/[slug].astro
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import SeverityTag from '../../components/SeverityTag.astro';
import ZeroDayTag from '../../components/ZeroDayTag.astro';
import ScoreDisplay from '../../components/ScoreDisplay.astro';

// Generate static pages for each report
export async function getStaticPaths() {
  const reportEntries = await getCollection('reports');
  return reportEntries.map(entry => ({
    params: { slug: entry.slug }, props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
---
<BaseLayout title={entry.data.title} description={entry.data.description}>
	<article class="prose prose-lg max-w-none dark:prose-invert"> {/* Ensure prose classes are applied */}
		{/* Report Header */}
		<header class="mb-8 border-b border-border pb-6">
			{/* CVE ID */}
			<h1 class="text-3xl font-bold text-primary mb-1">{entry.data.cveId}</h1>
			{/* Report Title */}
			<h2 class="text-xl font-semibold text-text-secondary mb-3">{entry.data.title}</h2>

			{/* Meta Info Row */}
			<div class="flex flex-wrap items-center gap-x-4 gap-y-2 mb-4">
				{/* Publish Date */}
				<div class="text-sm text-text-muted">
					Published: <time datetime={entry.data.publishDate.toISOString()}>
						{entry.data.publishDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
					</time>
				</div>
				{/* Severity & ZeroDay Tags */}
				<div class="flex items-center gap-2">
					{/* Use explicit severity if available, otherwise fallback to cvssSeverity */}
					{(entry.data.severity || entry.data.cvssSeverity) && <SeverityTag severity={entry.data.severity || entry.data.cvssSeverity} />}
					{entry.data.isZeroDay && <ZeroDayTag isZeroDay={entry.data.isZeroDay} />}
				</div>
			</div>

			{/* Scores Row */}
			<div class="flex flex-wrap items-center gap-x-4 gap-y-1 mb-4">
				<ScoreDisplay type="CVSS" score={entry.data.cvssScore} link={`https://nvd.nist.gov/vuln/detail/${entry.data.cveId}`} />
				<ScoreDisplay type="EPSS" score={entry.data.epssScore} link="https://www.first.org/epss/" />
				{/* Add CISA KEV status here if data becomes available */}
			</div>

			{/* Tags */}
			{entry.data.tags && entry.data.tags.length > 0 && (
				<div class="text-sm">
					{entry.data.tags.map(tag => (
						<span class="inline-block bg-secondary/10 text-secondary rounded px-2 py-0.5 mr-1 mb-1">#{tag}</span>
					))}
				</div>
			)}
		</header>

		{/* Report Content */}
		<Content />
	</article>
</BaseLayout>
